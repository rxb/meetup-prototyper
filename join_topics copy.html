<html>
<head>
	<!-- prototyper requires JS -->
	<script type="text/javascript" src="bower_components/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="bower_components/ractive/ractive.js"></script>
	<script type="text/javascript" src="bower_components/moment/moment.js"></script>
	<script type="text/javascript" src="js/helpers_ractive.js"></script>
	
	<!-- LATER 
	<script type="text/javascript" src="bower_components/handlebars/handlebars.min.js"></script>
	<script type="text/javascript" src="bower_components/underscore/underscore.js"></script>
	<script type="text/javascript" src="bower_components/backbone/backbone.js"></script>
	<script type="text/javascript" src="js/helpers.js"></script>
	-->
	
	<script type="text/javascript" src="js/gimme.js"></script>
	<script type="text/javascript" src="js/extras.js"></script>
	<script type="text/javascript" src="js/fastclick.js"></script>
	<script type="text/javascript" src="js/cats.js"></script>
	
	
	<link href="bower_components/sassquatch/css/sassquatch.css" type="text/css" rel="stylesheet" />
	<link href="css/whitney.css" type="text/css" rel="stylesheet" /> <!-- whitney will get bowerized -->
	<link href="css/patch.css" type="text/css" rel="stylesheet" />
	<link href="css/groups.css" type="text/css" rel="stylesheet" />
	
</head>
<body>

<script type="text/html" id="topiclist-template">
	Pick some topics yo
	<ul class="dividedList">
	{{#topics}}
		<li>{{name}}</li>
	{{/topics}}
	</ul>
</script>



<script type="text/html" id="main-template">

<div class="shade off" id="shade" style="display: none;"></div>

<div class="panel off" id="panel-topiclist" style="display: none;">
	<div class="doc-bounds--medium">
		<div class="doc-box" style="position: relative;">
			<div id="panel-topiclist-closse" class="clickable nobreak inverted" style="position: absolute; left: 50%; top: -50px; z-index: 2; font-size: 32px; width: 40px; text-align: center; margin-left: -20px; color: rgba(255,255,255,.4)"><span class="icon_close_alt2"></span></div>
			<div id="content-topiclist">
			</div>
		</div>
	</div>
</div>


<!-- screen start -->
<div class="doc-stripe" id="header"><div class="doc-bounds">
	<div class="line">	
		<div class="unit size1of2">
			<img src="https://secure.meetup.com/img/8308650022681532654/header/logo-2x.png" id="logo" />
		</div>

		<div class="unit size1of2 align-right">
			<a class="display-none inlineblock-at-handheld bold fake-feature" style="border-left: 1px solid #ddd; padding-left: 12px;">Next &raquo;</a>
		</div>

	</div>
</div></div>


<div class="doc-stripe"><div class="doc-bounds">
	
	<div class="fixflex">
		<div class="flex center-at-handheld">
			<h1>What are you interested in?</h1>
		</div>
		<div class="fix">
			<a href="" class="button fake-feature hide-at-handheld">Next</a>
		</div>
	</div>


	<ul class="" id="cats">
		{{#categories:i}}
			<li class="clickable">
				<div class="cat" data-index="{{i}}">
					{{#selected_count}}<div class="count">{{selected_count}}</div>{{/selected_count}}
					{{{localized_name}}}
				</div>
				<ul class="topics">
					{{#topics}}
						<li class="topic {{selected ? 'on' : ''}}" on-click="toggle_topic">
							{{name}}
						</li>
					{{/topics}}
					<li class="topic more" on-click="get_more_topics">+ more</li>
				</ul>
			</li>
		{{/categories}}
	</ul>	
	

</div></div>

</script>




<script type="text/javascript">

$(function(){	
	
	// kill 300ms delay
	FastClick.attach(document.body);
	
	/* 
	* Uncomment the data you want -- it will be available in the template 
	* Check out the Meetup API docs for a list of fields to use in the template
	* http://www.meetup.com/meetup_api/docs/
	*
	* A few notes:
	* -- You can specify any field supported by the API
	* -- You can leave every field unspecified except "gimme" -- something random/fun will be picked for you.
	*/
	
	/* Add your own pre-rendering JS here */
	function getHashParams() {
		var hashParams = {};
		var e, a = /\+/g,
			// Regex for replacing addition symbol with a space
			r = /([^&;=]+)=?([^&;]*)/g,
			d = function(s) {
				return decodeURIComponent(s.replace(a, " "));
			},
			q = window.location.hash.substring(1);

		while (e = r.exec(q))
		hashParams[d(e[1])] = d(e[2]);

		return hashParams;
	}
	var opts = getHashParams();	

	
	var shoppingList = [
		//{"gimme": "groups", "page": 40, "zip": "97227"},		
		//{"gimme": "group"},
		//{"gimme": "open_events"}, 
		//{"gimme": "dates_with_open_events"}, 
		//{"gimme": "events", "page": 15}, 
		//{"gimme": "event"},		
		//{"gimme": "rsvps"},	
		//{"gimme": "event_comments"},
		//{"gimme": "photo_albums"},
		//{"gimme": "photos"},
		//{"gimme": "members", "page": 40},
		//{"gimme": "profile"},
		//{"gimme": "categories"},
		//{"gimme": "discussions", "page": 9}
	];

	var new_topics = JSON.parse(JSON.stringify(cats[0].topics)); // this is gross 

	var extraContext = $.extend( shoppingList, {
		"opts": opts,
		"categories": cats
	} ); // anything else to add to the handlebars context?
	
	
	
	// Let's go!
	//var gme = new Gimme(shoppingList, function(){
		var ractive = new Ractive( {el: 'body', template: '#main-template', data: extraContext });			
		defaultRenderCompleteActions(); // do standard jquery magicks
		

		// get container size, set unit size
		var active_cat = -1;
		var w = $('#cats').width();
		var units_per_row = 7 // make this dynamic per screen size
		var unit = w/units_per_row;
		var drawer_h = unit * 1.5;
		var $cats = $('#cats > li');
		$('#cats').css({'position': 'relative'});
		
		function layout_cats(){
			// set positions
			var active_row = (active_cat) ? Math.floor( active_cat  / units_per_row ) : false;
			for(var i = 0; i<$cats.length; i++){
				var $this = $($cats[i]);
				var $cat = $this.find('.cat');
				var $topics_wrap = $this.find('.topics');
				var row = Math.floor( i  / units_per_row );
				var col = i % units_per_row;
				var top = ( active_row > -1 && row > active_row ) ? drawer_h : 0 ;
				var new_css;
				if(i == active_cat){
					new_css = { 
						'transform': 'translate3d(0, '+top+'px, 0) scale(1)',
						'top': (unit * row)+'px',
						'left': (unit * col)+'px'
					};
					$topics_wrap.show();				
				}
				else{
					new_css = { 
						'transform': 'translate3d(0, '+top+'px, 0) scale(.75)',
						'top': (unit * row)+'px',
						'left': (unit * col)+'px'
					};	
					$topics_wrap.hide();				
				}
				
				setTimeout( function(cat, css){
					return function(){
						cat.css(css);	
					};
				}($cat, new_css), col*20);	
				
				// position topics wrappers
				$topics_wrap.css({
					'top': (unit * (row + 1))+'px',
					'left': 0
				});
				layout_topics($topics_wrap);
			};
			
			// set #cats height to rows * units + drawer_h
			$('#cats').height( Math.ceil($cats.length/units_per_row) * unit + drawer_h );
			
		}
		layout_cats();

		// expand, collapse
		$(document).on('click', '.cat', function(){
			new_cat = $(this).data('index');
			if(new_cat == active_cat){
				// toggle closed currently open cat
				active_cat = -1;
				$('#cats, .cat').removeClass('on');
			}
			else{
				active_cat = new_cat;
				$('.cat').removeClass('on')
				$(this).addClass('on');
				$("#cats").addClass('on');
			}
			layout_cats();
		});
		
		/*
		
		always 2 positions
		
		
		*/
		function layout_topics($topics_wrap){
			// position each topic in a janky way for now
			var $topics = $topics_wrap.find('.topic');
			var topic_h = $topics.first().height();
			var row_cursor = 0;
			var row_w = 0;
			var topic_offset = 12;
			for(var n = 0; n<$topics.length; n++){
				$this_topic = $($topics[n]);
				this_topic_w = $this_topic.outerWidth();
				if(row_w + this_topic_w > w){
					row_cursor++;
					row_w = 0;
				}
				$this_topic.removeClass('animate');
				$this_topic.css({
					'transform': 'translate3d('+row_w + 'px, '+(row_cursor * (topic_h + topic_offset))+'px, 0)'
				});
				row_w += (this_topic_w + topic_offset);
			}
		}

		
		ractive.on({
			'toggle_topic': function(event){
				if(event.context.selected){
					ractive.set(event.keypath+".selected", false);
				}
				else{
					ractive.set(event.keypath+".selected", true);					
				}
			},
			'get_more_topics': function(event){
				// can i just do this stuff by reference?
				var len = ractive.get(event.keypath+".topics.length");
				for(var i=(len-1); i >= 0; i--){
					if(! ractive.get(event.keypath+".topics."+i+".selected") ){
						ractive.splice(event.keypath+".topics", i, 1);
					}
				}
				
				var these_new_topics = JSON.parse(JSON.stringify(new_topics)); // this is gross 
				for(var i=0; i < these_new_topics.length; i++){
					ractive.push(event.keypath+".topics", these_new_topics[i]);
				}
				layout_topics( $(event.node).parent() );
			}
		});
		
		
		ractive.observe({
			'categories[*].topics[*].selected': function(n,o,k, index){
				if(typeof n == 'undefined'){
					console.log('init');
				}
				else{
					if(n === true){
						ractive.add('categories.'+index+'.selected_count');
					}
					else{
						ractive.subtract('categories.'+index+'.selected_count');
					}
				}

			}
		});
		
		
		/*	
		$(document).on('click', '.topic', function(){
			var $this = $(this);
			if($this.hasClass('more')){
				
				// clear unused topics & layout
				var $topics_wrap = $this.parent();
				$topics_wrap.find('li:not(.on)').remove();
				//layout_topics($topics_wrap);
				
				// add new topics & layout
				for(var i=0; i<15; i++){
					$topics_wrap.append('<li class="topic">Something new</li>');					
				}
				$topics_wrap.append('<li class="topic more">+ More</li>');	
				layout_topics($topics_wrap);
			}
			else{
				if($this.hasClass('on')){
					$this.removeClass('on');
				}
				else{
					$this.addClass('on');
				}
			}

		});
		*/
			

	//}, extraContext);
});
</script>

<div id="template-holder"></div>

</body>
</html>

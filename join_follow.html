<html>
<head>
	<script type="text/javascript" src="bower_components/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="bower_components/handlebars/handlebars.min.js"></script>
	<script type="text/javascript" src="bower_components/moment/min/moment.min.js"></script>
	<script type="text/javascript" src="bower_components/unveil/jquery.unveil.min.js"></script>
	<script type="text/javascript" src="bower_components/lazyloadxt/dist/jquery.lazyloadxt.js"></script>
	<script type="text/javascript" src="bower_components/lazyloadxt/dist/jquery.lazyloadxt.bg.js"></script>
	
	<script type="text/javascript" src="js/helpers.js"></script>
	<script type="text/javascript" src="js/gimme.js"></script>
	<script type="text/javascript" src="js/extras.js"></script>
	<script type="text/javascript" src="js/fastclick.js"></script>
	
	<link href="bower_components/sassquatch/css/sassquatch.css" type="text/css" rel="stylesheet" />
	<link href="css/whitney.css" type="text/css" rel="stylesheet" /> <!-- whitney will get bowerized -->
	<link href="css/patch.css" type="text/css" rel="stylesheet" />
	<link href="css/groups.css" type="text/css" rel="stylesheet" />
	
	
	<meta name='viewport' content='content="width=device-width, maximum-scale=1.0, minimum-scale=1.0, initial-scale=1.0' />

</head>
<body>
	
<script type="text/html" id="eventlist-template">
	{{#if events}}
		<h4>We have Meetups like&hellip;</h4>
		<ul>
		{{#events}}
			<li>{{name}}</li>
		{{/events}}
		</ul>
	{{/if}}
</script>


<script type="text/html" id="groupinfo-template">
		
	{{#group}}

		<div class="nametag-photo inverted" id="panel-photo" style="background-image: url({{photo}});">
			<div class="nametag-photo-name">
				<div class="doc-content align-center">
					<h2 class="padding-none">{{name}}</h2>
					<p class="muted">We're {{numberFormat members}} {{who}}</p>
				</div>
			</div>
		</div>
	{{/group}}
		
		<div class="doc-content">
			<div class="line linear-at-handheld" style="border-bottom: 1px solid #ddd; margin-bottom: 16px; padding-bottom: 8px;">
				
				<div class="unit size1of2 hide-at-handheld">
					{{#organizer}}
					<div class="figureset">
						<div class="figureset-figure">
							<div class="avatar avatar-60 clickable" style="background-image:  url('{{photo}}'), url('http://api.randomuser.me/0.3/portraits/women/1.jpg'); margin-top: -6px; margin-bottom: 0;"></div>
						</div>
						<div class="figureset-description">
							Organized by: 
							<h5>{{name}}</h5>
						</div>
					</div>
					{{/organizer}}
				</div>

				<div class="unit size1of2 align-right">
					<span class="panel-follow button primary block-at-handheld clickable" data-group_id="{{group.id}}" onclick="">Follow this group</span>
				</div>
			</div>
			
			
			<!-- TEST BUTTONS -->
			<div class="align-center">
			    <div class="button primary" id="follow" style="position: relative; vertical-align: top; padding-right: 34px;">
					<span class="hideable" id="follow_label">Follow&nbsp;&nbsp;&nbsp;</span>
					<div class="fillable followable" style="position: absolute; top: 2px; right: 8px;">
						<div class="filled" id="follow_filled"></div>
					</div>
			    </div>
			    <div class="hideable hid" id="join_wrap">
				    <div class="button primary">
				    	Become a member
				    </div>
			    </div>
			</div>
			<!-- /TEST BUTTONS -->
			
			
			<div id="content-eventlist"></div>
			
			<h4>About us</h4>
			<p>{{{group.description}}}</p>
		</div>

</script>


<script type="text/html" id="main-template">
<!-- pages -->
<div class="shade off" id="shade" style="display: none;"></div>

<div class="panel off" id="panel-groupinfo" style="display: none;" onclick="">
	<div class="doc-bounds--medium">
		<div id="panel-groupinfo-close" class="clickable nobreak inverted" style="position: absolute; left: 50%; top: 16px; z-index: 2; font-size: 32px; width: 44px; text-align: center; margin-left: -20px; color: rgba(255,255,255,.5); font-weight: bold;"><img src="css/close.svg" width="32px" /></div>
		<div class="doc-box" style="overflow:auto; height: calc(100% - 60px); -webkit-overflow-scrolling: touch;" id="content-groupinfo">
		</div>
	</div>
</div>



<!-- screen start -->
<div class="doc-stripe" id="header"><div class="doc-bounds">
	<div class="line">	
		<div class="unit size1of2">
			<img src="https://secure.meetup.com/img/8308650022681532654/header/logo-2x.png" id="logo" />
		</div>

		<div class="unit size1of2 align-right">
			<a class="display-none inlineblock-at-handheld bold fake-feature" style="border-left: 1px solid #ddd; padding-left: 12px;">Next &raquo;</a>
		</div>

	</div>
</div></div>


<div class="doc-stripe bg-gray"><div class="doc-bounds">
	
	<div class="fixflex">
		<div class="flex center-at-handheld">
			<h1>Follow some groups</h1>
			<p>What looks interesting? Follow groups so you won't miss out on great Meetups!</p>
		</div>
		<div class="fix">
			<a href="" class="button fake-feature hide-at-handheld">Next</a>
		</div>
	</div>

	


    <ul class="blockList has3 has2-at-medium has1-at-handheld divided" id="grouplist">
    	{{#each groups}}
		
			<!--
			{{#compare @index 15}}
				{{#../../interests}}
	    		<li>
		    		<div class="doc-box inverted" style="background: rgb(57, 135, 203);">
						<div class="doc-content">
							<p class="margin-minimal">{{numberFormat count}} people near Portland are interested in a</p>
							<h2>{{name}}</h2>
							<p>Meetup Group</p>
						</div>
						<div class="doc-content">
							<p>You can start one <i class="arrow_carrot-right" style="font-size: 20px; float: right" /></p>
						</div>
					</div>
				{{/../../interests}}
			{{/compare}}
			-->
			
			
	    	<li onclick="" class="clickable" style="-webkit-tap-highlight-color: rgba(0,0,0,0);"><!-- crazy but mobile safari needs blank onclick -->
	    		<div class="doc-box group" data-group="{{json .}}">
	    			<div class="nametag-photo" data-bg="{{photo}}" style="/* background-image: url({{photo}}); */"><div class="nametag-photo-name">
	    				<div class="doc-content inverted">
	    					<h3 class="margin-minimal">{{name}}</h3>
	    				</div>
	    			</div></div>
	    			<div class="">
						<div class="fixflex">
							<div class="flex small doc-content" style="position: relative;">
		    					<p><strong style="white-space: nowrap;">{{numberFormat members}} {{truncateMean who 19}}</strong><br />
								{{#next_event}}Next Meetup {{dateRelative time}}{{/next_event}}&nbsp;</p>
							</div>
							<div class="fix doc-content clickable J_follow" style="vertical-align: top; border-top: none" id="follow-{{id}}" onclick="">
								<div class="fillable followable">
									<div class="filled"></div>
								</div>
								<div class="followlabel diffword" data-diffword="Following">Follow</div>
							</div>
						</div>
	    			</div>
	    		</div>
	    	<!-- no </li> tag to avoid whitespace -->
	{{/each}}
	
	
</ul>
</div></div>



</script>




<script type="text/javascript">


$(function(){	
	// kill 300ms delay
	FastClick.attach(document.body);
	
	// lazy load background imgs
	$.extend($.lazyLoadXT, { edgeY:  900 });
	
	/* 
	* Uncomment the data you want -- it will be available in the template 
	* Check out the Meetup API docs for a list of fields to use in the template
	* http://www.meetup.com/meetup_api/docs/
	*
	* A few notes:
	* -- You can specify any field supported by the API
	* -- You can leave every field unspecified except "gimme" -- something random/fun will be picked for you.
	*/
	
	/* Add your own pre-rendering JS here */
	
	var shoppingList = [
		{"gimme": "groups", "page": 80, "zip": 97034},	
		//{"gimme": "group"},
		//{"gimme": "open_events"}, 
		//{"gimme": "dates_with_open_events"}, 
		//{"gimme": "events", "page": 15}, 
		//{"gimme": "event"},		
		//{"gimme": "rsvps"},	
		//{"gimme": "event_comments"},
		//{"gimme": "photo_albums"},
		//{"gimme": "photos"},
		//{"gimme": "members", "page": 40},
		//{"gimme": "profile"},
		//{"gimme": "categories"},
		//{"gimme": "discussions", "page": 9}
	];
	
	var extraContext = $.extend( shoppingList, { "interests": [
		{"name": "Hiking", "count": 1023},
		{"name": "Swimming", "count": 5102},
		{"name": "Javascript", "count": 69}
	]} ); // anything else to add to the handlebars context?
	
	
	// Let's go!
	var gme = new Gimme(shoppingList, function(){
		$("#template-holder").load('./js/partials.html', function(){ // load partials
			$('body').append( Handlebars.compile( $('#main-template').html() )( gme.context ) ); // render template
			defaultRenderCompleteActions(); // do standard jquery magicks
			
			$('.nametag-photo').lazyLoadXT();
			
			// Set up follow/following diffs
			// Could be much more efficient if set up in the template
			//$('.diffword').diffword();

			// Group info popups
			// Fetches group info
			$(document).on('click', '.group', function(e){
				
				var eventContext = {};
				var eventsLoaded = false
				var panelDisplayed = false;
				function renderEvents(){
					if(eventsLoaded && panelDisplayed){
						$('#content-eventlist').html( Handlebars.compile( $('#eventlist-template').html() )( eventContext ) );						
					}
				}
				
				// FIRST, POP UP GROUP PANEL WITH AVAILABLE INFO
				var group = $(this).data('group');
				var context = {};
				context.group = group;
				// hackery for private groups
				// this	is a demo-only thing
				context.organizer = group.organizer;				
				$('#content-groupinfo').html( Handlebars.compile( $('#groupinfo-template').html() )( context ) );
				setTimeout(function(){
					$('#shade,#panel-groupinfo').css({'display':'block'});
					setTimeout(function(){
						$('#content-groupinfo').scrollTop(0);
						$('#shade').removeClass('off');					
						$('#panel-groupinfo').removeClass('off');					
						$('#panel-groupinfo').one(transitionEnd, function(){
							panelDisplayed = true;
							renderEvents();
						});
					}, 1);
				}, 1);
		

				
				// THEN LOAD THE MISSING STUFF
				var shoppingList = [
					{"gimme": "events", "page": 4, "group_id": group.id},
				];
				
				var group_gme = new Gimme(shoppingList, function(){
					var context = group_gme.context;
					// de-dup events
					// weird if there are 5 identically named "Monthly Meetup" events in a row
					var looped_events = [];
					context.events = $.map(context.events, function(n, i){
						if(looped_events.indexOf(n.name) == -1){
							looped_events.push(n.name);
							return n;
						}
						else{
							return;
						}
					});
					eventsLoaded = true;
					eventContext = context;
					renderEvents();
					
				});
				
				
				// TEMPORARILY, TEST BUTTONS
				var following = false;
				var $follow = $('#follow');
				var $follow_label = $('#follow_label');
				var $follow_filled = $('#follow_filled');
				var $join = $('#join_wrap');

				$('#follow').click(function(){
				  if(following){
				    following = false;
					$follow.removeClass('ghost');
				    $follow_filled.removeClass('on');
				    $follow_label.removeClass('hid');
				    $join.addClass('hid');


				  }
				  else{
				    following = true;
				    $follow_filled.addClass('on');
					$follow.addClass('ghost');
			    
				    setTimeout(function(){
						$follow_label.addClass('hid');
				        $join.removeClass('hid');
				    }, 1000);
				  }
				});
				

				return false;
			});
			

			$(document).on('click', '.J_follow', function(e){
				var $this = $(this);
				toggleFollow($this)
				return false;
			});


			// TODO: Check for current followed / nonfollowed state of group
			$(document).on('click', '.panel-follow', function(){
				var $this = $(this);
				closePanel();	
				setTimeout(function(){
					toggleFollow($('#follow-'+$this.data("group_id")))					
				}, 300);
				return false;		
			});
			
			// click outside of popup panel, close the popup panel
			$(document).click(function (e){
				if( $("#panel-groupinfo").hasClass("off") ){
					return true;
				}
				
			    var container = $("#panel-groupinfo .doc-box");
			    if (!container.is(e.target) // if the target of the click isn't the container...
			        && container.has(e.target).length === 0) // ... nor a descendant of the container
			    {
			        //container.hide();
					closePanel();
			    }
			});
			
			
			function closePanel(){
				$('#panel-groupinfo').addClass('off');
				$('#panel-groupinfo').one(transitionEnd, function(){
					$(this).css({'display':'none'});
				});
				
				$('#shade').addClass('off');
				$('#shade').one(transitionEnd, function(){
					$(this).css({'display':'none'});
				});
			}
			
			function toggleFollow($this){
				var $filled = $this.find('.filled');
				var $label = $this.find('.followlabel');				
				
				if($filled.data('on') == true){
					$filled.removeClass('on');
					$filled.data('on', false);
					$filled.one(transitionEnd, function(){
						$label.removeClass('show_diff2').addClass('show_diff1');
					});

				}
				else{
					$filled.data('on', true);
					$filled.addClass('on');	
					$filled.one(transitionEnd, function(){
						$label.removeClass('show_diff1').addClass('show_diff2');
					});
				}
			}
			
			
		});
	}, extraContext);
});


// JQUERY plugin sets up the follow/following strings 
// doing this as a diff because of trn
// could be MUCH better at diffing the two strings
$.fn.diffword = function(){
	return this.each(function() {
		var $this = $(this);
		var start = $this.text();
		var end = $this.data('diffword');
		
		var newhtml = [];
		for (var i = 0, len = Math.max(start.length, end.length); i < len; i++) {
			if(start[i] == end[i]){
				newhtml.push('<span class="diff1 diff2">'+start[i]+'</span>');
			}
			else{
				if(i<start.length){
					newhtml.push('<span class="diff1">'+start[i]+'</span>');															
				}
				if(i<end.length){
					newhtml.push('<span class="diff2">'+end[i]+'</span>');							
				}
			}
		}
		$this.html(newhtml.join('')).addClass('show_diff1');
	});
};

</script>

<div id="template-holder"></div>

</body>
</html>
